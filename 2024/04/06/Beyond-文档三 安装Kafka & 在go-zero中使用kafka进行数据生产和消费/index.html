
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Beyond 文档三 安装Kafka &amp; 在go-zero中使用kafka进行数据生产和消费 | luckyy-code</title>
    <meta name="author" content="段雨超" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
    <link rel="icon" href="/images/avatar.jpg" />


    <link rel="preconnect" href="https://s4.zstatic.net" />
<script src="https://s4.zstatic.net/ajax/libs/vue/3.3.7/vue.global.prod.min.js"></script>
<link rel="stylesheet" href="https://s4.zstatic.net/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
<link rel="preconnect" href="https://fonts.loli.net" />
<link rel="preconnect" href="https://gstatic.loli.net" crossorigin />
<link rel="stylesheet" href="https://fonts.loli.net/css2?family=Fira+Code:wght@400;500;600;700&family=Lexend:wght@400;500;600;700;800;900&family=Noto+Sans+SC:wght@400;500;600;700;800;900&display=swap" />
<script> const mixins = {}; </script>

<script src="https://polyfill.io/v3/polyfill.min.js?features=default"></script>


<script src="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://s4.zstatic.net/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link
    rel="stylesheet"
    href="https://s4.zstatic.net/ajax/libs/highlight.js/11.9.0/styles/github.min.css"
/>
<script src="/js/lib/highlight.js"></script>



<script src="/js/lib/preview.js"></script>









<link rel="stylesheet" href="/css/main.css" />

<meta name="generator" content="Hexo 6.3.0"></head>
<body>
    <div id="layout">
        <transition name="fade">
            <div id="loading" v-show="loading">
                <div id="loading-circle">
                    <h2>LOADING</h2>
                    <p>加载过慢请开启缓存 浏览器默认开启</p>
                    <img src="/images/loading.gif" />
                </div>
            </div>
        </transition>
        <div id="menu" :class="{ hidden: hiddenMenu, 'menu-color': menuColor}">
    <nav id="desktop-menu">
        <a class="title" href="/">
            <span>LUCKYY-CODE</span>
        </a>
        
        <a href="/">
            <i class="fa-solid fa-house fa-fw"></i>
            <span>&ensp;Home</span>
        </a>
        
        <a href="/about">
            <i class="fa-solid fa-id-card fa-fw"></i>
            <span>&ensp;About</span>
        </a>
        
        <a href="/archives">
            <i class="fa-solid fa-box-archive fa-fw"></i>
            <span>&ensp;Archives</span>
        </a>
        
        <a href="/categories">
            <i class="fa-solid fa-bookmark fa-fw"></i>
            <span>&ensp;Categories</span>
        </a>
        
        <a href="/tags">
            <i class="fa-solid fa-tags fa-fw"></i>
            <span>&ensp;Tags</span>
        </a>
        
    </nav>
    <nav id="mobile-menu">
        <div class="title" @click="showMenuItems = !showMenuItems">
            <i class="fa-solid fa-bars fa-fw"></i>
            <span>&emsp;LUCKYY-CODE</span>
        </div>
        <transition name="slide">
            <div class="items" v-show="showMenuItems">
                
                <a href="/">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-house fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Home</div>
                    </div>
                </a>
                
                <a href="/about">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-id-card fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">About</div>
                    </div>
                </a>
                
                <a href="/archives">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-box-archive fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Archives</div>
                    </div>
                </a>
                
                <a href="/categories">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-bookmark fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Categories</div>
                    </div>
                </a>
                
                <a href="/tags">
                    <div class="item">
                        <div style="min-width: 20px; max-width: 50px; width: 10%">
                            <i class="fa-solid fa-tags fa-fw"></i>
                        </div>
                        <div style="min-width: 100px; max-width: 150%; width: 20%">Tags</div>
                    </div>
                </a>
                
            </div>
        </transition>
    </nav>
</div>
<transition name="fade">
    <div id="menu-curtain" @click="showMenuItems = !showMenuItems" v-show="showMenuItems"></div>
</transition>

        <div id="main" :class="loading ? 'into-enter-from': 'into-enter-active'">
            <div class="article">
    <div>
        <h1>Beyond 文档三 安装Kafka &amp; 在go-zero中使用kafka进行数据生产和消费</h1>
    </div>
    <div class="info">
        <span class="date">
            <span class="icon">
                <i class="fa-solid fa-calendar fa-fw"></i>
            </span>
            2024/4/6
        </span>
        
        
        <span class="tags">
            <span class="icon">
                <i class="fa-solid fa-tags fa-fw"></i>
            </span>
            
            
            <span class="tag">
                
                <a href="/tags/Beyond/" style="color: #00a596">Beyond</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/golang/" style="color: #ff7d73">golang</a>
            </span>
            
            <span class="tag">
                
                <a href="/tags/%E6%96%87%E6%A1%A3/" style="color: #00bcd4">文档</a>
            </span>
            
        </span>
        
    </div>
    
    <div class="content" v-pre>
        <p>安装Kafka &amp; 在go-zero中使用kafka进行数据生产和消费</p>
<span id="more"></span>

<h3 id="安装kafka"><a href="#安装kafka" class="headerlink" title="安装kafka"></a>安装kafka</h3><p><a target="_blank" rel="noopener" href="https://kafka.apache.org/downloads">点击下载kafka</a></p>
<p>选择二进制下载</p>
<p>下载后进行解压</p>
<pre><code class="shell">tar -zxvf kafka_2.12-3.6.1.tgz 
</code></pre>
<h4 id="进入kafka执行命令目录"><a href="#进入kafka执行命令目录" class="headerlink" title="进入kafka执行命令目录"></a>进入kafka执行命令目录</h4><pre><code class="shell">cd  kafka_2.12-3.6.1
</code></pre>
<h4 id="启动zookeeper-service"><a href="#启动zookeeper-service" class="headerlink" title="启动zookeeper service"></a>启动zookeeper service</h4><pre><code class="shell"> ./bin/zookeeper-server-start.sh config/zookeeper.properties #Start the ZooKeeper service
</code></pre>
<h4 id="启动kafka-service"><a href="#启动kafka-service" class="headerlink" title="启动kafka service"></a>启动kafka service</h4><pre><code class="shell">./bin/kafka-server-start.sh config/server.properties  #Start the Kafka broker service
</code></pre>
<h4 id="cd到bin目录下"><a href="#cd到bin目录下" class="headerlink" title="cd到bin目录下"></a>cd到bin目录下</h4><pre><code class="shell">cd bin
</code></pre>
<h4 id="创建topic"><a href="#创建topic" class="headerlink" title="创建topic"></a>创建topic</h4><pre><code class="shell">./bin/kafka-topics.sh --create --topic topic-beyond-like --bootstrap-server localhost:9092
</code></pre>
<h4 id="查看topic信息"><a href="#查看topic信息" class="headerlink" title="查看topic信息"></a>查看topic信息</h4><pre><code class="shell">./kafka-topics.sh --describe --topic topic-beyond-like --bootstrap-server localhost:9092
</code></pre>
<h4 id="生产消费"><a href="#生产消费" class="headerlink" title="生产消费"></a>生产消费</h4><pre><code class="shell">./kafka-console-producer.sh --topic topic-beyond-like --bootstrap-server localhost:9092
</code></pre>
<h4 id="消费消息"><a href="#消费消息" class="headerlink" title="消费消息"></a>消费消息</h4><pre><code class="shell">./kafka-console-consumer.sh --topic topic-beyond-like --from-beginning --bootstrap-server localhost:9092
</code></pre>
<h4 id="创建点赞表"><a href="#创建点赞表" class="headerlink" title="创建点赞表"></a>创建点赞表</h4><pre><code class="sql">create database beyond_like;
use beyond_like;

CREATE TABLE `like_record` (
                               `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,
                               `biz_id` varchar(64) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;业务ID&#39;,
                               `obj_id` bigint(20) UNSIGNED NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;点赞对象id&#39;,
                               `user_id` bigint(20) UNSIGNED NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;用户ID&#39;,
                               `like_type` tinyint(4) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;类型 0:点赞 1:点踩&#39;,
                               `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
                               `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;最后修改时间&#39;,
                               PRIMARY KEY (`id`),
                               KEY `ix_update_time` (`update_time`),
                               UNIQUE KEY `uk_biz_obj_uid` (`biz_id`,`obj_id`,`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;点赞记录表&#39;;

CREATE TABLE `like_count` (
                              `id` bigint(20) UNSIGNED NOT NULL AUTO_INCREMENT COMMENT &#39;主键ID&#39;,
                              `biz_id` varchar(64) NOT NULL DEFAULT &#39;&#39; COMMENT &#39;业务ID&#39;,
                              `obj_id` bigint(20) UNSIGNED NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;点赞对象id&#39;,
                              `like_num` int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;点赞数&#39;,
                              `dislike_num` int(11) NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;点踩数&#39;,
                              `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#39;创建时间&#39;,
                              `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT &#39;最后修改时间&#39;,
                              PRIMARY KEY (`id`),
                              KEY `ix_update_time` (`update_time`),
                              UNIQUE KEY `uk_biz_obj` (`biz_id`,`obj_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;点赞计数表&#39;;
</code></pre>
<h4 id="编写proto文件生成rpc服务"><a href="#编写proto文件生成rpc服务" class="headerlink" title="编写proto文件生成rpc服务"></a>编写proto文件生成rpc服务</h4><pre><code class="go">syntax = &quot;proto3&quot;;

package pb;

option go_package=&quot;./pb&quot;;

service Like &#123;
  rpc Thumbup(ThumbupRequest) returns (ThumbupResponse);
  rpc IsThumbup(IsThumbupRequest) returns (IsThumbupResponse);
&#125;

message ThumbupRequest &#123;
  string bizId = 1; // 业务id
  int64 objId = 2; // 点赞对象id
  int64 userId  = 3; // 用户id
  int32 likeType = 4; // 类型
&#125;

message ThumbupResponse &#123;
  string bizId = 1; // 业务id
  int64 objId = 2; // 点赞对象id
  int64 likeNum = 3; // 点赞数
  int64 dislikeNum = 4; // 点踩数
&#125;

message IsThumbupRequest &#123;
  string bizId = 1; // 业务id
  int64 targetId = 2; // 点赞对象id
  int64 userId  = 3; // 用户id
&#125;

message IsThumbupResponse &#123;
  map&lt;int64, UserThumbup&gt; userThumbups = 1;
&#125;

message UserThumbup &#123;
  int64 userId = 1;
  int64 thumbupTime = 2;
  int32 likeType = 3; // 类型
&#125;
</code></pre>
<pre><code class="shell">goctl rpc protoc *.proto --go_out=../ --go-grpc_out=../ --zrpc_out=../ --style=goZero
</code></pre>
<h4 id="生成model"><a href="#生成model" class="headerlink" title="生成model"></a>生成model</h4><pre><code class="shell">goctl model mysql datasource --dir ./internal/model  --cache true --url &quot;root
123456@tcp(127.0.0.1:3306)/beyond_like&quot;
</code></pre>
<h3 id="生产者"><a href="#生产者" class="headerlink" title="生产者"></a>生产者</h3><h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><pre><code class="yaml">KqPusherConf:
  Brokers:
    - 127.0.0.1:9092
  Topic: topic-beyond-like
</code></pre>
<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4><pre><code class="go">type ServiceContext struct &#123;
   Config         config.Config
   KqPusherClient *kq.Pusher
&#125;

func NewServiceContext(c config.Config) *ServiceContext &#123;
   return &amp;ServiceContext&#123;
      Config:         c,
      KqPusherClient: kq.NewPusher(c.KqPusherConf.Brokers, c.KqPusherConf.Topic),
   &#125;
&#125;
</code></pre>
<h4 id="发送kafka消息"><a href="#发送kafka消息" class="headerlink" title="发送kafka消息"></a>发送kafka消息</h4><pre><code class="go">func (l *ThumbupLogic) Thumbup(in *service.ThumbupRequest) (*service.ThumbupResponse, error) &#123;
   // TODO 逻辑暂时忽略
   // 1. 查询是否点过赞
   // 2. 计算当前内容的总点赞数和点踩数

   msg := &amp;types.ThumbupMsg&#123;
      BizId:    in.BizId,
      ObjId:    in.ObjId,
      UserId:   in.UserId,
      LikeType: in.LikeType,
   &#125;
   // 发送kafka消息，异步
   threading.GoSafe(func() &#123;
      data, err := json.Marshal(msg)
      if err != nil &#123;
         l.Logger.Errorf(&quot;[Thumbup] marshal msg: %+v error: %v&quot;, msg, err)
         return
      &#125;
      err = l.svcCtx.KqPusherClient.Push(string(data))
      if err != nil &#123;
         l.Logger.Errorf(&quot;[Thumbup] kq push data: %s error: %v&quot;, data, err)
      &#125;

   &#125;)

   return &amp;service.ThumbupResponse&#123;&#125;, nil
&#125;
</code></pre>
<h3 id="消费者"><a href="#消费者" class="headerlink" title="消费者"></a>消费者</h3><h4 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h4><pre><code class="yaml">Name: mq
KqConsumerConf:
  Name: like-kq-consumer
  Brokers:
    - 127.0.1:9092
  Group: group-beyond-like
  Topic: topic-beyond-like
  Offset: last
  Consumers: 1
  Processors: 1
</code></pre>
<h4 id="消费kafka消息"><a href="#消费kafka消息" class="headerlink" title="消费kafka消息"></a>消费kafka消息</h4><pre><code class="go">type ThumbupLogic struct &#123;
   ctx    context.Context
   svcCtx *svc.ServiceContext
   logx.Logger
&#125;

func NewThumbupLogic(ctx context.Context, svcCtx *svc.ServiceContext) *ThumbupLogic &#123;
   return &amp;ThumbupLogic&#123;
      ctx:    ctx,
      svcCtx: svcCtx,
      Logger: logx.WithContext(ctx),
   &#125;
&#125;

func (l *ThumbupLogic) Consume(key, val string) error &#123;
   fmt.Printf(&quot;get key: %s val: %s\n&quot;, key, val)
   return nil
&#125;

func Consumers(ctx context.Context, svcCtx *svc.ServiceContext) []service.Service &#123;
   return []service.Service&#123;
      kq.MustNewQueue(svcCtx.Config.KqConsumerConf, NewThumbupLogic(ctx, svcCtx)),
   &#125;
&#125;
</code></pre>
<h3 id="postman测试"><a href="#postman测试" class="headerlink" title="postman测试"></a>postman测试</h3><h4 id="启动like-rpc和like-mq"><a href="#启动like-rpc和like-mq" class="headerlink" title="启动like-rpc和like-mq"></a>启动like-rpc和like-mq</h4><p><img src="https://telegraph-image-d8w.pages.dev/file/0fa58b7671744e6bb9f9a.png"></p>
<p><img src="https://telegraph-image-d8w.pages.dev/file/66aa720d5bddbe7108172.png"></p>
<p>成功消费到消息！！！</p>

    </div>
    
    
    
    
    
    
    
</div>

            <footer id="footer">
    <div id="footer-wrap">
        <div>
            &copy;
            2022 - 2024 luckyy-code
            <span id="footer-icon">
                <i class="fa-solid fa-font-awesome fa-fw"></i>
            </span>
            &commat;段雨超
        </div>
        <div>
            Based on the <a target="_blank" rel="noopener" href="https://hexo.io">Hexo Engine</a> &amp;
            <a target="_blank" rel="noopener" href="https://github.com/theme-particlex/hexo-theme-particlex">ParticleX Theme</a>
        </div>
        
    </div>
</footer>

        </div>
        
        <transition name="fade">
            <div id="preview" ref="preview" v-show="previewShow">
                <img id="preview-content" ref="previewContent" />
            </div>
        </transition>
        
    </div>

    <canvas class="fireworks" style="position: fixed;left: 0;top: 0;z-index: 1; pointer-events: none;" ></canvas>
    <script type="text/javascript" src="//cdn.bootcss.com/animejs/2.2.0/anime.min.js"></script>
    <script type="text/javascript" src="/js/fireworks.js"></script>

    <script src="/js/main.js"></script>
    <script src="/js/lib/fireworks.js>"></script>

    
    




    
</body>
</html>
